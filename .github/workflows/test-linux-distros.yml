name: Test Linux Distributions

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            autoconf automake build-essential clang cmake execstack fakeroot \
            git libc-ares-dev libctemplate-dev libcurl4-openssl-dev \
            libglib2.0-dev libicu-dev libsasl2-dev \
            libsasl2-modules libsasl2-modules-gssapi-mit libsecret-1-dev \
            libssl-dev libnss3 libnss3-dev \
            libtidy-dev libtool libxext-dev libxkbfile-dev libxml2-dev \
            libxtst-dev rpm uuid-dev

      - name: Create directories
        run: |
          mkdir -p ../app
          mkdir -p ../app/dist

      - name: Run build script
        run: ./build.sh

      - name: Upload artifact for testing
        uses: actions/upload-artifact@v4
        with:
          name: mailsync-linux
          path: ../app/dist/mailsync.tar.gz
          retention-days: 1

  test-fedora:
    needs: build-linux
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        fedora_version: ['40', '41']
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: mailsync-linux

      - name: Test on Fedora ${{ matrix.fedora_version }}
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace fedora:${{ matrix.fedora_version }} bash -c "
            set -e
            echo '=== Testing mailsync on Fedora ${{ matrix.fedora_version }} ==='

            # Install required runtime dependencies
            dnf install -y glibc libstdc++ libcurl openssl libicu libuuid cyrus-sasl-lib

            # Extract and test mailsync
            cd /workspace
            tar -xzf mailsync.tar.gz

            # Run mailsync and capture output
            echo 'Running mailsync --help...'
            ./mailsync --help 2>&1 | tee /tmp/output.txt || true

            # Verify help message is printed
            if grep -q 'USAGE:' /tmp/output.txt && grep -q 'CONFIG_DIR_PATH' /tmp/output.txt; then
              echo '✓ mailsync runs successfully and prints help message on Fedora ${{ matrix.fedora_version }}'
            else
              echo '✗ mailsync failed to print expected help message'
              cat /tmp/output.txt
              exit 1
            fi
          "

  test-arch:
    needs: build-linux
    runs-on: ubuntu-22.04
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: mailsync-linux

      - name: Test on Arch Linux
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace archlinux:latest bash -c "
            set -e
            echo '=== Testing mailsync on Arch Linux ==='

            # Update package database and install required runtime dependencies
            pacman -Syu --noconfirm
            pacman -S --noconfirm glibc gcc-libs curl openssl icu util-linux-libs cyrus-sasl

            # Extract and test mailsync
            cd /workspace
            tar -xzf mailsync.tar.gz

            # Run mailsync and capture output
            echo 'Running mailsync --help...'
            ./mailsync --help 2>&1 | tee /tmp/output.txt || true

            # Verify help message is printed
            if grep -q 'USAGE:' /tmp/output.txt && grep -q 'CONFIG_DIR_PATH' /tmp/output.txt; then
              echo '✓ mailsync runs successfully and prints help message on Arch Linux'
            else
              echo '✗ mailsync failed to print expected help message'
              cat /tmp/output.txt
              exit 1
            fi
          "

  test-ubuntu:
    needs: build-linux
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        ubuntu_version: ['22.04', '24.04']
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: mailsync-linux

      - name: Test on Ubuntu ${{ matrix.ubuntu_version }}
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace ubuntu:${{ matrix.ubuntu_version }} bash -c "
            set -e
            echo '=== Testing mailsync on Ubuntu ${{ matrix.ubuntu_version }} ==='

            # Install required runtime dependencies
            apt-get update
            apt-get install -y libcurl4 libssl3 libicu-dev uuid-runtime libsasl2-2

            # Extract and test mailsync
            cd /workspace
            tar -xzf mailsync.tar.gz

            # Run mailsync and capture output
            echo 'Running mailsync --help...'
            ./mailsync --help 2>&1 | tee /tmp/output.txt || true

            # Verify help message is printed
            if grep -q 'USAGE:' /tmp/output.txt && grep -q 'CONFIG_DIR_PATH' /tmp/output.txt; then
              echo '✓ mailsync runs successfully and prints help message on Ubuntu ${{ matrix.ubuntu_version }}'
            else
              echo '✗ mailsync failed to print expected help message'
              cat /tmp/output.txt
              exit 1
            fi
          "
