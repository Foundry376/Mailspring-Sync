name: Build Windows

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  create:
    tags:
      - '*'

env:
  VCPKG_DEFAULT_TRIPLET: x86-windows
  VCPKG_DEFAULT_HOST_TRIPLET: x86-windows

jobs:
  build-windows:
    runs-on: windows-2022

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore vcpkg cache
        uses: actions/cache/restore@v4
        id: vcpkg-cache
        with:
          path: ${{ github.workspace }}/vcpkg/installed
          key: vcpkg-x86-windows-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}

      - name: Setup vcpkg
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '84bab45d415d22042bd0b9081aea57f362da3f35'

      - name: Set VCPKG_ROOT
        shell: pwsh
        run: echo "VCPKG_ROOT=${{ github.workspace }}/vcpkg" >> $env:GITHUB_ENV

      - name: Install vcpkg dependencies
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          Write-Host "Installing vcpkg dependencies for x86-windows..."
          Write-Host "VCPKG_ROOT is: $env:VCPKG_ROOT"
          # Use --x-install-root to install to $VCPKG_ROOT/installed where our vcxproj files expect them
          vcpkg install --triplet x86-windows --x-install-root="$env:VCPKG_ROOT/installed"
          Write-Host "Listing installed libraries:"
          Get-ChildItem "$env:VCPKG_ROOT/installed/x86-windows/lib" -ErrorAction SilentlyContinue | Select-Object Name
          Write-Host "vcpkg install completed"

      - name: Save vcpkg cache
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ${{ github.workspace }}/vcpkg/installed
          key: vcpkg-x86-windows-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}

      - name: Set commit hash
        shell: pwsh
        run: |
          $commit = $env:GITHUB_SHA.Substring(0,8)
          echo "COMMIT=$commit" >> $env:GITHUB_ENV

      - name: Create app directory
        shell: pwsh
        run: mkdir ..\app

      - name: Install VC2010 as we need msvcr100.dll
        shell: cmd
        run: choco install -y vcredist2010

      - name: Build with MSBuild
        shell: cmd
        run: cd Windows && msbuild.exe mailsync.sln /property:Configuration=Release;Platform=Win32

      - name: Copy build artifacts and dependencies
        shell: pwsh
        run: |
          if (!(Test-Path "..\app\dist")) { New-Item -ItemType Directory -Path "..\app\dist" }

          # Copy build output
          Copy-Item ".\Windows\Release\*" -Destination "..\app\dist" -Recurse -Force

          # Copy vcpkg DLLs
          $vcpkgBin = "$env:VCPKG_ROOT\installed\x86-windows\bin"
          Write-Host "Copying vcpkg DLLs from $vcpkgBin"
          if (Test-Path $vcpkgBin) {
            Copy-Item "$vcpkgBin\*.dll" -Destination "..\app\dist" -Force -ErrorAction SilentlyContinue
          }

          # Copy vendored SASL DLL (not available via vcpkg for x86-windows)
          Copy-Item ".\Vendor\libetpan\third-party\lib\sasl2.dll" -Destination "..\app\dist" -Force

          # Copy MSVC runtime DLLs
          Copy-Item "C:\Windows\SysWOW64\msvcr100.dll" "..\app\dist\" -Force -ErrorAction SilentlyContinue
          Copy-Item "C:\Windows\SysWOW64\msvcr120.dll" "..\app\dist\" -Force -ErrorAction SilentlyContinue
          Copy-Item "C:\Windows\SysWOW64\msvcp100.dll" "..\app\dist\" -Force -ErrorAction SilentlyContinue
          Copy-Item "C:\Windows\SysWOW64\msvcp120.dll" "..\app\dist\" -Force -ErrorAction SilentlyContinue
          Copy-Item "C:\Windows\SysWOW64\msvcp140.dll" "..\app\dist\" -Force -ErrorAction SilentlyContinue
          Copy-Item "C:\Windows\SysWOW64\vcruntime140.dll" "..\app\dist\" -Force -ErrorAction SilentlyContinue

          # Copy UCRT DLLs
          $ucrtPath = "C:\Program Files (x86)\Windows Kits\10\Redist\ucrt\DLLs\x86"
          if (Test-Path $ucrtPath) {
            Copy-Item "$ucrtPath\*" "..\app\dist\" -Force -ErrorAction SilentlyContinue
          }

      - name: List build artifacts
        shell: pwsh
        run: |
          Write-Host "=== vcpkg bin directory contents ==="
          Get-ChildItem "$env:VCPKG_ROOT\installed\x86-windows\bin\*.dll" | Select-Object Name | Sort-Object Name

          Write-Host ""
          Write-Host "=== Build output (app\dist) ==="
          Get-ChildItem "..\app\dist\*.dll" | Select-Object Name | Sort-Object Name

          Write-Host ""
          Write-Host "=== ICU DLLs in vcpkg bin ==="
          Get-ChildItem "$env:VCPKG_ROOT\installed\x86-windows\bin\icu*.dll" -ErrorAction SilentlyContinue | Select-Object Name

          Write-Host ""
          Write-Host "=== Checking for expected DLLs ==="
          $expectedDlls = @(
            "libcrypto-3.dll",
            "libssl-3.dll",
            "libcurl.dll",
            "libxml2.dll",
            "zlib1.dll",
            "tidy.dll",
            "ctemplate.dll",
            "pthreadVC3.dll",
            "mailcore2.dll",
            "libetpan.dll",
            "sasl2.dll",
            "iconv.dll"
          )
          foreach ($dll in $expectedDlls) {
            $path = "..\app\dist\$dll"
            if (Test-Path $path) {
              Write-Host "OK: $dll"
            } else {
              Write-Host "MISSING: $dll"
            }
          }

          Write-Host ""
          Write-Host "=== Full listing ==="
          (Get-ChildItem -Force -Path ..\app).FullName
          (Get-ChildItem -Force -Path ..\app\dist).FullName

      - name: Create archive
        shell: cmd
        run: |
          cd Windows
          7z -ttar a dummy ..\..\app\dist\*.dll ..\..\app\dist\*.pdb ..\..\app\dist\mailsync.exe -so | 7z -si -tgzip a .\mailsync.tar.gz

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: win-ia32-mailsync
          path: Windows/mailsync.tar.gz

      # Run install-check to verify SSL/TLS connectivity to Gmail and identity server.
      # This validates that curl, OpenSSL, and mailcore2 are all working correctly.
      - name: Run install-check
        shell: pwsh
        run: |
          Write-Host "=== Running mailsync install-check on Windows ==="

          # Create a directory with 'mailspring' in the path (required by branding check in main.cpp)
          $testDir = "$env:TEMP\mailspring"
          New-Item -ItemType Directory -Force -Path $testDir | Out-Null

          # Copy mailsync.exe and all DLLs to the test directory
          Copy-Item "..\app\dist\*" -Destination $testDir -Recurse -Force

          # Debug: List all DLLs in the test directory
          Write-Host "=== DLLs in test directory ==="
          Get-ChildItem "$testDir\*.dll" | Select-Object Name | Sort-Object Name

          # Debug: Check dependencies using dumpbin
          $dumpbin = Get-ChildItem -Path "C:\Program Files\Microsoft Visual Studio\2022" -Recurse -Filter "dumpbin.exe" -ErrorAction SilentlyContinue | Where-Object { $_.FullName -match "Hostx64\\x86" } | Select-Object -First 1
          if ($dumpbin) {
            Write-Host "=== Dependencies of mailsync.exe ==="
            & $dumpbin.FullName /dependents "$testDir\mailsync.exe" 2>&1
            Write-Host "=== Dependencies of mailcore2.dll ==="
            & $dumpbin.FullName /dependents "$testDir\mailcore2.dll" 2>&1
            Write-Host "=== Dependencies of libetpan.dll ==="
            & $dumpbin.FullName /dependents "$testDir\libetpan.dll" 2>&1
            Write-Host "=== Dependencies of libcurl.dll ==="
            & $dumpbin.FullName /dependents "$testDir\libcurl.dll" 2>&1
          } else {
            Write-Host "dumpbin.exe not found, skipping dependency check"
          }

          # Set environment variables and run install-check
          $env:CONFIG_DIR_PATH = $env:TEMP
          $env:IDENTITY_SERVER = "https://id.getmailspring.com"

          Write-Host "Running mailsync --mode install-check..."
          $process = Start-Process -FilePath "$testDir\mailsync.exe" `
            -ArgumentList "--mode", "install-check" `
            -PassThru -Wait -NoNewWindow `
            -RedirectStandardOutput "$env:TEMP\output.txt" `
            -RedirectStandardError "$env:TEMP\error.txt"

          $exitCode = $process.ExitCode

          Write-Host "Output:"
          if (Test-Path "$env:TEMP\output.txt") { Get-Content "$env:TEMP\output.txt" }
          if (Test-Path "$env:TEMP\error.txt") {
            $errorContent = Get-Content "$env:TEMP\error.txt" -ErrorAction SilentlyContinue
            if ($errorContent) {
              Write-Host "Stderr:"
              Write-Host $errorContent
            }
          }

          # Check for failure indicators in output
          $output = ""
          if (Test-Path "$env:TEMP\output.txt") {
            $output = Get-Content "$env:TEMP\output.txt" -Raw
          }

          if ($output -match "One or more checks failed") {
            Write-Host "X mailsync install-check failed on Windows"
            exit 1
          } elseif ($exitCode -ne 0) {
            Write-Host "X mailsync install-check failed with exit code $exitCode"
            exit 1
          } else {
            Write-Host "OK mailsync install-check passed on Windows"
          }

      - name: Deploy to S3
        if: github.ref == 'refs/heads/master'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
        shell: pwsh
        run: |
          # Upload to S3
          $archivePath = "Windows/mailsync.tar.gz"
          $s3Key = "mailsync/$env:COMMIT/win-ia32/mailsync.tar.gz"

          aws s3 cp $archivePath s3://mailspring-builds/$s3Key --acl public-read
