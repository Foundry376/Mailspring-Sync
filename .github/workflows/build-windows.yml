name: Build Windows

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  create:
    tags:
      - '*'

env:
  VCPKG_DEFAULT_TRIPLET: x86-windows
  VCPKG_DEFAULT_HOST_TRIPLET: x86-windows

jobs:
  build-windows:
    runs-on: windows-2022

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup vcpkg and install dependencies
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '84bab45d415d22042bd0b9081aea57f362da3f35'
          runVcpkgInstall: true

      - name: Set commit hash
        shell: pwsh
        run: |
          $commit = $env:GITHUB_SHA.Substring(0,8)
          echo "COMMIT=$commit" >> $env:GITHUB_ENV

      - name: Create app directory
        shell: pwsh
        run: mkdir ..\app

      - name: Install VC2010 as we need msvcr100.dll
        shell: cmd
        run: choco install -y vcredist2010

      - name: Build with MSBuild
        shell: cmd
        run: cd Windows && msbuild.exe mailsync.sln /property:Configuration=Release;Platform=Win32

      - name: Copy build artifacts and dependencies
        shell: pwsh
        run: |
          if (!(Test-Path "..\app\dist")) { New-Item -ItemType Directory -Path "..\app\dist" }

          # Copy build output
          Copy-Item ".\Windows\Release\*" -Destination "..\app\dist" -Recurse -Force

          # Copy vcpkg DLLs
          $vcpkgBin = "$env:VCPKG_ROOT\installed\x86-windows\bin"
          Write-Host "Copying vcpkg DLLs from $vcpkgBin"
          if (Test-Path $vcpkgBin) {
            Copy-Item "$vcpkgBin\*.dll" -Destination "..\app\dist" -Force -ErrorAction SilentlyContinue
          }

          # Copy vendored SASL DLL (not available via vcpkg for x86-windows)
          Copy-Item ".\Vendor\libetpan\third-party\lib\sasl2.dll" -Destination "..\app\dist" -Force

          # Copy MSVC runtime DLLs
          Copy-Item "C:\Windows\SysWOW64\msvcr100.dll" "..\app\dist\" -Force -ErrorAction SilentlyContinue
          Copy-Item "C:\Windows\SysWOW64\msvcr120.dll" "..\app\dist\" -Force -ErrorAction SilentlyContinue
          Copy-Item "C:\Windows\SysWOW64\msvcp100.dll" "..\app\dist\" -Force -ErrorAction SilentlyContinue
          Copy-Item "C:\Windows\SysWOW64\msvcp120.dll" "..\app\dist\" -Force -ErrorAction SilentlyContinue
          Copy-Item "C:\Windows\SysWOW64\msvcp140.dll" "..\app\dist\" -Force -ErrorAction SilentlyContinue
          Copy-Item "C:\Windows\SysWOW64\vcruntime140.dll" "..\app\dist\" -Force -ErrorAction SilentlyContinue

          # Copy UCRT DLLs
          $ucrtPath = "C:\Program Files (x86)\Windows Kits\10\Redist\ucrt\DLLs\x86"
          if (Test-Path $ucrtPath) {
            Copy-Item "$ucrtPath\*" "..\app\dist\" -Force -ErrorAction SilentlyContinue
          }

      - name: List build artifacts
        shell: pwsh
        run: |
          (Get-ChildItem -Force -Path ..\app).FullName
          (Get-ChildItem -Force -Path ..\app\dist).FullName

      - name: Create archive
        shell: cmd
        run: |
          cd Windows
          7z -ttar a dummy ..\..\app\dist\*.dll ..\..\app\dist\*.pdb ..\..\app\dist\mailsync.exe -so | 7z -si -tgzip a .\mailsync.tar.gz

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: win-ia32-mailsync
          path: Windows/mailsync.tar.gz

      # Run install-check to verify SSL/TLS connectivity to Gmail and identity server.
      # This validates that curl, OpenSSL, and mailcore2 are all working correctly.
      - name: Run install-check
        shell: pwsh
        run: |
          Write-Host "=== Running mailsync install-check on Windows ==="

          # Create a directory with 'mailspring' in the path (required by branding check in main.cpp)
          $testDir = "$env:TEMP\mailspring"
          New-Item -ItemType Directory -Force -Path $testDir | Out-Null

          # Copy mailsync.exe and all DLLs to the test directory
          Copy-Item "..\app\dist\*" -Destination $testDir -Recurse -Force

          # Set environment variables and run install-check
          $env:CONFIG_DIR_PATH = $env:TEMP
          $env:IDENTITY_SERVER = "https://id.getmailspring.com"

          Write-Host "Running mailsync --mode install-check..."
          $process = Start-Process -FilePath "$testDir\mailsync.exe" `
            -ArgumentList "--mode", "install-check" `
            -PassThru -Wait -NoNewWindow `
            -RedirectStandardOutput "$env:TEMP\output.txt" `
            -RedirectStandardError "$env:TEMP\error.txt"

          $exitCode = $process.ExitCode

          Write-Host "Output:"
          if (Test-Path "$env:TEMP\output.txt") { Get-Content "$env:TEMP\output.txt" }
          if (Test-Path "$env:TEMP\error.txt") {
            $errorContent = Get-Content "$env:TEMP\error.txt" -ErrorAction SilentlyContinue
            if ($errorContent) {
              Write-Host "Stderr:"
              Write-Host $errorContent
            }
          }

          # Check for failure indicators in output
          $output = ""
          if (Test-Path "$env:TEMP\output.txt") {
            $output = Get-Content "$env:TEMP\output.txt" -Raw
          }

          if ($output -match "One or more checks failed") {
            Write-Host "X mailsync install-check failed on Windows"
            exit 1
          } elseif ($exitCode -ne 0) {
            Write-Host "X mailsync install-check failed with exit code $exitCode"
            exit 1
          } else {
            Write-Host "OK mailsync install-check passed on Windows"
          }

      - name: Deploy to S3
        if: github.ref == 'refs/heads/master'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
        shell: pwsh
        run: |
          # Upload to S3
          $archivePath = "Windows/mailsync.tar.gz"
          $s3Key = "mailsync/$env:COMMIT/win-ia32/mailsync.tar.gz"

          aws s3 cp $archivePath s3://mailspring-builds/$s3Key --acl public-read
