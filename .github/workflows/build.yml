name: Build and Upload Artifacts

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  create:
    tags:
      - '*'

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-22.04, macos-latest]
        include:
          - os: ubuntu-22.04
          - os: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up codesigning (MacOS)
        if: runner.os == 'macOS' # && (github.ref == 'refs/heads/master')
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.APPLE_CODESIGN_P12 }}
          p12-password: ${{ secrets.APPLE_CODESIGN_KEY_PASSWORD }}

      - name: Set up dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt update
          sudo apt install -y \
            autoconf automake build-essential clang cmake execstack fakeroot \
            git libc-ares-dev libctemplate-dev libcurl4-openssl-dev \
            libglib2.0-dev libicu-dev libsasl2-dev \
            libsasl2-modules libsasl2-modules-gssapi-mit libsecret-1-dev \
            libssl-dev libnss3 libnss3-dev \
            libtidy-dev libtool libxext-dev libxkbfile-dev libxml2-dev \
            libxtst-dev rpm uuid-dev xvfb

      - name: Start Xvfb (Linux)
        if: runner.os == 'Linux'
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            Xvfb :99 & export DISPLAY=:99.0
          fi

      - name: Create directories
        run: |
          mkdir -p ../app
          mkdir -p ../app/dist

      - name: Run build script
        run: ./build.sh

      - name: Verify universal binary architectures (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "Verifying mailsync binary architectures..."
          ARCHS=$(lipo -archs ../app/mailsync)
          echo "Architectures found: $ARCHS"

          if [[ "$ARCHS" != *"arm64"* ]]; then
            echo "ERROR: arm64 architecture not found in binary"
            exit 1
          fi

          if [[ "$ARCHS" != *"x86_64"* ]]; then
            echo "ERROR: x86_64 architecture not found in binary"
            exit 1
          fi

          echo "Universal binary verification passed: $ARCHS"
          lipo -info ../app/mailsync

      - name: Run install-check (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "=== Running mailsync install-check on macOS ==="

          # Create a directory with 'mailspring' in the path (required by branding check)
          mkdir -p /tmp/mailspring
          cp ../app/mailsync /tmp/mailspring/mailsync
          chmod +x /tmp/mailspring/mailsync

          # Run install-check to verify SSL/TLS connectivity
          echo "Running mailsync --mode install-check..."
          CONFIG_DIR_PATH=/tmp IDENTITY_SERVER=https://id.getmailspring.com /tmp/mailspring/mailsync --mode install-check > /tmp/output.txt 2>&1 || true
          cat /tmp/output.txt
          echo ""

          # Verify install check passed
          if grep -q 'One or more checks failed' /tmp/output.txt; then
            echo "✗ mailsync install-check failed on macOS"
            exit 1
          else
            echo "✓ mailsync install-check passed on macOS"
          fi

      - name: Setup AWS CLI
        if: success() && (github.ref == 'refs/heads/master')
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Upload artifact
        if: success() && (github.ref == 'refs/heads/master')
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            OS_DIR="linux"
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            OS_DIR="osx"
          else
            OS_DIR="$RUNNER_OS"
          fi
          aws s3 sync ../app/dist s3://mailspring-builds/mailsync/${GITHUB_SHA:0:8}/${OS_DIR}/ --delete

      - name: Copy Linux artifact for upload
        if: runner.os == 'Linux'
        run: cp ../app/dist/mailsync.tar.gz ./mailsync.tar.gz

      - name: Upload Linux artifact for distribution testing
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: mailsync-linux
          path: mailsync.tar.gz
          retention-days: 1

      - name: Cache build dependencies
        uses: actions/cache@v4
        with:
          path: /tmp/mailsync-build-deps-v2
          key: ${{ runner.os }}-mailsync-deps-${{ hashFiles('**/build.sh') }}
          restore-keys: |
            ${{ runner.os }}-mailsync-deps-

  test-fedora:
    needs: build
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        fedora_version: ['40', '41', '43']
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: mailsync-linux

      - name: Test on Fedora ${{ matrix.fedora_version }}
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace fedora:${{ matrix.fedora_version }} bash -c "
            set -e
            echo '=== Testing mailsync on Fedora ${{ matrix.fedora_version }} ==='

            # Install required runtime dependencies (from RPM spec)
            dnf install -y glibc libstdc++ libcurl openssl libicu libuuid cyrus-sasl-lib \
              libXScrnSaver libsecret libtidy ca-certificates libappindicator-gtk3 file

            # Extract to a directory containing 'mailspring' in the path
            # (required by branding check in main.cpp that exits with code 2)
            cd /workspace
            mkdir -p mailspring
            cd mailspring
            tar -xzf ../mailsync.tar.gz

            # Debug: show extracted files and binary info
            echo 'Extracted files:'
            ls -la
            echo ''
            echo 'Wrapper script (mailsync):'
            cat ./mailsync
            echo ''
            echo 'Binary info (mailsync.bin):'
            file ./mailsync.bin
            echo ''

            echo 'Checking for missing shared libraries:'
            ldd ./mailsync.bin || true
            echo ''

            # Run mailsync install-check via wrapper (wrapper sets LD_LIBRARY_PATH and SASL_PATH)
            # Note: || true prevents set -e from exiting on non-zero; we check output instead
            echo 'Running mailsync --mode install-check...'
            CONFIG_DIR_PATH=/tmp IDENTITY_SERVER=https://id.getmailspring.com ./mailsync --mode install-check > /tmp/output.txt 2>&1 || true
            cat /tmp/output.txt
            echo ''

            # Verify install check passed (no errors)
            if grep -q 'One or more checks failed' /tmp/output.txt; then
              echo '✗ mailsync install-check failed on Fedora ${{ matrix.fedora_version }}'
              echo 'Checking for missing libraries (not found):'
              ldd ./mailsync.bin 2>&1 | grep 'not found' || echo 'No missing libraries detected'
              exit 1
            else
              echo '✓ mailsync install-check passed on Fedora ${{ matrix.fedora_version }}'
            fi
          "

  test-arch:
    needs: build
    runs-on: ubuntu-22.04
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: mailsync-linux

      - name: Test on Arch Linux
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace archlinux:latest bash -c "
            set -e
            echo '=== Testing mailsync on Arch Linux ==='

            # Update package database and install required runtime dependencies
            # Only install what mailsync CLI actually needs (not GUI dependencies)
            pacman -Syu --noconfirm
            pacman -S --noconfirm glibc gcc-libs curl openssl icu util-linux-libs cyrus-sasl file \
              libsecret tidy ca-certificates libgcrypt nss glib2

            # Extract to a directory containing 'mailspring' in the path
            # (required by branding check in main.cpp that exits with code 2)
            cd /workspace
            mkdir -p mailspring
            cd mailspring
            tar -xzf ../mailsync.tar.gz

            # Debug: show extracted files and binary info
            echo 'Extracted files:'
            ls -la
            echo ''
            echo 'Wrapper script (mailsync):'
            cat ./mailsync
            echo ''
            echo 'Binary info (mailsync.bin):'
            file ./mailsync.bin
            echo ''

            echo 'Checking for missing shared libraries:'
            ldd ./mailsync.bin || true
            echo ''

            # Run mailsync install-check via wrapper (wrapper sets LD_LIBRARY_PATH and SASL_PATH)
            # Note: || true prevents set -e from exiting on non-zero; we check output instead
            echo 'Running mailsync --mode install-check...'
            CONFIG_DIR_PATH=/tmp IDENTITY_SERVER=https://id.getmailspring.com ./mailsync --mode install-check > /tmp/output.txt 2>&1 || true
            cat /tmp/output.txt
            echo ''

            # Verify install check passed (no errors)
            if grep -q 'One or more checks failed' /tmp/output.txt; then
              echo '✗ mailsync install-check failed on Arch Linux'
              echo 'Checking for missing libraries (not found):'
              ldd ./mailsync.bin 2>&1 | grep 'not found' || echo 'No missing libraries detected'
              exit 1
            else
              echo '✓ mailsync install-check passed on Arch Linux'
            fi
          "

  test-ubuntu:
    needs: build
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        ubuntu_version: ['22.04', '24.04']
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: mailsync-linux

      - name: Test on Ubuntu ${{ matrix.ubuntu_version }}
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace ubuntu:${{ matrix.ubuntu_version }} bash -c "
            set -e
            echo '=== Testing mailsync on Ubuntu ${{ matrix.ubuntu_version }} ==='

            # Install required runtime dependencies (from debian control.in)
            apt-get update
            apt-get install -y libcurl4 libssl3 libicu-dev uuid-runtime libsasl2-2 \
              libsecret-1-dev libgtk2.0-0 libudev1 libgcrypt20 libnotify4 libxtst6 \
              libnss3 libglib2.0-bin xdg-utils libtidy-dev file

            # Extract to a directory containing 'mailspring' in the path
            # (required by branding check in main.cpp that exits with code 2)
            cd /workspace
            mkdir -p mailspring
            cd mailspring
            tar -xzf ../mailsync.tar.gz

            # Debug: show extracted files and binary info
            echo 'Extracted files:'
            ls -la
            echo ''
            echo 'Wrapper script (mailsync):'
            cat ./mailsync
            echo ''
            echo 'Binary info (mailsync.bin):'
            file ./mailsync.bin
            echo ''

            echo 'Checking for missing shared libraries:'
            ldd ./mailsync.bin || true
            echo ''

            # Run mailsync install-check via wrapper (wrapper sets LD_LIBRARY_PATH and SASL_PATH)
            # Note: || true prevents set -e from exiting on non-zero; we check output instead
            echo 'Running mailsync --mode install-check...'
            CONFIG_DIR_PATH=/tmp IDENTITY_SERVER=https://id.getmailspring.com ./mailsync --mode install-check > /tmp/output.txt 2>&1 || true
            cat /tmp/output.txt
            echo ''

            # Verify install check passed (no errors)
            if grep -q 'One or more checks failed' /tmp/output.txt; then
              echo '✗ mailsync install-check failed on Ubuntu ${{ matrix.ubuntu_version }}'
              echo 'Checking for missing libraries (not found):'
              ldd ./mailsync.bin 2>&1 | grep 'not found' || echo 'No missing libraries detected'
              exit 1
            else
              echo '✓ mailsync install-check passed on Ubuntu ${{ matrix.ubuntu_version }}'
            fi
          "
